var weitherAPI="http://api.openweathermap.org/data/2.5/weather?appid=2de143494c0b295cca9337e1e96b00e0&lang=zh&callback=?&q=",transitionend="transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",API={get:"http://5.vgee.sinaapp.com/s1/jsonp.php?callback=?",post:"http://5.vgee.sinaapp.com/s1/jsonpost.php?callback=?"},icons={"01":"&#xe604;","02":"&#xe603;","03":"&#xe606;","04":"&#xe601;","09":"&#xe600;",10:"&#xe607;",11:"&#xe602;",13:"&#xe608;",50:"&#xe605;"},PICS=20;$.fn.toShow=function(){return $(this).removeClass("hide").addClass("show")},$.fn.toHide=function(){return $(this).removeClass("show").addClass("hide")};var loadUserMsg=function(t){var e={},i=new Date;ipLoc=window.remote_ip_info,e.text=$(".edit #msg").val(),e.location=ipLoc.city||ipLoc.province||"北京",e.time=i.getMonth()+1+"/"+i.getDate()+" "+i.getHours()+":"+i.getMinutes();var n=weitherAPI+e.location;$.getJSON(n).success(function(t){return"404"==t.cod?(e.temp=0,void(e.weither="未知")):(e.temp=(t.main.temp-273.15).toFixed(0),e.weither=t.weather[0].description,e.w_icon=t.weather[0].icon.slice(0,2),void(e.img="http://7xp0x5.com1.z0.glb.clouddn.com/photo"+Math.ceil(PICS*Math.random())+".png"))}).fail(function(){e.temp="未知"}).done(function(){t(e)})},userData,postData=function(t){var e=userData.user,i=userData.text.replace(/\n/g,"/_rt/"),n=userData.weither,o=userData.location;wall_w_icon=userData.w_icon,wall_img=userData.img;var a="&wall_author="+e+"&wall_message="+i+"&wall_weither="+n+"&wall_city="+o+"&wall_w_icon="+wall_w_icon+"&wall_img="+wall_img;console.log(a),$.getJSON(API.post+a).success(function(e){t.waiting=!1,e.success?window.location.href="list.html":alert(e)})},init=function(){$("#msg").textareaAutoSize().focus(),$(".submit").click(function(t){t.preventDefault();var e=Cookies.get("user");return e||(e=window.prompt("你叫什么呢？（小于10个字符)",""),e||(e=window.prompt("别淘气，你叫啥？","")),e.length>10&&(e=window.prompt("名字太非主流不好（小于10个字符)",e)),Cookies.set("user",e,{expires:1e3,path:"/"})),$(".edit #msg").val()?($(this).addClass("circle"),void loadUserMsg(function(t){t.user=e,userData=t,console.log(t),$(this).removeClass("circle"),$(".edit").toHide().one(transitionend,function(){$(this).unbind(transitionend).hide(),$(".preview").show().find("#prepre").text(t.text).end().find("#picture").attr("src",t.img).end().find("#i-temp").html(icons[t.w_icon]).end().find("#temp").text(t.weither).end().find("#time").text(t.time).end().find("#loc").text(t.location).end().find(".user span").text(t.user).end(),setTimeout(function(){$(".preview").toShow()})})}.bind(this))):void alert("总得说点什么吧")}),$(".ret").click(function(){$(".preview").toHide().one(transitionend,function(){$(this).unbind(transitionend).hide(),$(".edit").show(),setTimeout(function(){$(".edit").toShow()})})}),$(".go").click(function(){this.waiting||(this.waiting=!0,postData(this))}),$(".mask").click(function(){alert("程序员大爷正在开发图片上传功能呢，敬请期待")}),$("#picture").click(function(){userData.img="http://7xp0x5.com1.z0.glb.clouddn.com/photo"+Math.ceil(PICS*Math.random())+".png",$(this).attr("src",userData.img)})};$(function(){FastClick.attach(document.body),init()});var test=function(){};