var weitherAPI="http://api.openweathermap.org/data/2.5/weather?appid=44db6a862fba0b067b1930da0d769e98&lang=zh&callback=?&q=",transitionend="transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",API={get:"http://5.vgee.sinaapp.com/s1/jsonp.php?callback=?",post:"http://5.vgee.sinaapp.com/s1/jsonpost.php?callback=?"},icons={"01":"&#xe604;","02":"&#xe603;","03":"&#xe606;","04":"&#xe601;","09":"&#xe600;",10:"&#xe607;",11:"&#xe602;",13:"&#xe608;",50:"&#xe605;"},PICS=20;$.fn.toShow=function(){return $(this).removeClass("hide").addClass("show")},$.fn.toHide=function(){return $(this).removeClass("show").addClass("hide")};var loadUserMsg=function(t){var e={},i=new Date;ipLoc=window.remote_ip_info,e.text=$(".edit #msg").val(),e.location=ipLoc.city||ipLoc.province||"北京",e.time=i.getMonth()+1+"/"+i.getDate()+" "+i.getHours()+":"+i.getMinutes();var o=weitherAPI+e.location;$.getJSON(o).success(function(t){return"404"==t.cod?(e.temp=0,void(e.weither="未知")):(e.temp=(t.main.temp-273.15).toFixed(0),e.weither=t.weather[0].description,void(e.w_icon=t.weather[0].icon.slice(0,2)))}).fail(function(){console.log("fail"),e.temp="未知"}).always(function(){console.log("done"),e.img=$(".thumb").attr("src"),"1pxgray.png"==e.img&&(e.img="http://7xp0x5.com1.z0.glb.clouddn.com/photo"+Math.ceil(PICS*Math.random())+".png"),t(e)})},userData,postData=function(t){var e=userData.user,i=userData.text.replace(/\n/g,"/_rt/"),o=userData.weither,n=userData.location;wall_w_icon=userData.w_icon,wall_img=userData.img;var a="&wall_author="+e+"&wall_message="+i+"&wall_weither="+o+"&wall_city="+n+"&wall_w_icon="+wall_w_icon+"&wall_img="+wall_img;console.log(a),$.getJSON(API.post+a).success(function(e){t.waiting=!1,e.success?window.location.href="list.html":alert(e)})},init=function(){$("#msg").textareaAutoSize().focus(),$(".submit").click(function(t){t.preventDefault();var e=Cookies.get("user");return e||(e=window.prompt("你叫什么呢？（小于10个字符)",""),e||(e=window.prompt("别淘气，你叫啥？","")),e.length>10&&(e=window.prompt("名字太非主流不好（小于10个字符)",e)),Cookies.set("user",e,{expires:1e3,path:"/"})),$(".edit #msg").val()?($(this).addClass("circle"),void loadUserMsg(function(t){t.user=e,userData=t,console.log(t),$(this).removeClass("circle"),$(".edit").toHide().one(transitionend,function(){$(this).unbind(transitionend).hide(),$(".preview").show().find("#prepre").text(t.text).end().find("#picture").attr("src",t.img).end().find("#i-temp").html(icons[t.w_icon]).end().find("#temp").text(t.weither).end().find("#time").text(t.time).end().find("#loc").text(t.location).end().find(".user span").text(t.user).end(),setTimeout(function(){$(".preview").toShow()})})}.bind(this))):void alert("总得说点什么吧")}),$(".ret").click(function(){$(".preview").toHide().one(transitionend,function(){$(this).unbind(transitionend).hide(),$(".edit").show(),setTimeout(function(){$(".edit").toShow()})})}),$(".go").click(function(){this.waiting||(this.waiting=!0,postData(this))}),$("#picture").click(function(){userData.img="http://7xp0x5.com1.z0.glb.clouddn.com/photo"+Math.ceil(PICS*Math.random())+".png",$(this).attr("src",userData.img)})},guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,i="x"==t?e:3&e|8;return i.toString(16)})},previewImage=function(t,e){if(t&&/image\//.test(t.type))if("image/gif"==t.type){var i=new mOxie.FileReader;i.onload=function(){e(i.result),i.destroy(),i=null},i.readAsDataURL(t.getSource())}else{var o=new mOxie.Image;o.onload=function(){o.downsize(300,300);var t="image/jpeg"==o.type?o.getAsDataURL("image/jpeg",80):o.getAsDataURL();e&&e(t),o.destroy(),o=null},o.load(t.getSource())}};plupload.addFileFilter("limit_sharp",function(t,e,i){if(!t)return void i(!0);if("[object Array]"!==Object.prototype.toString.call(t))return void i(!0);var o=t[0],n=t[1],a=t[2],s=o/n,r=this,l=new mOxie.Image;l.load(e.getSource()),l.onload=function(){c(l)},l.onerror=function(){c(!1)};var c=function(t){if(!t)return void i(!1);console.log(t.width),console.log(t.height);var l=t.width/t.height,c=Math.abs(s-l);c>.01?(r.trigger("Error",{code:-888,message:"File sharp error.",file:e,img:{width:o,height:n}}),i(!1)):a&&t.width<a?(r.trigger("Error",{code:-889,message:"File size too small.",file:e,img:{width:o,height:n}}),i(!1)):i(!0)}}),initUploader=function(t,e,i,o,n){var a=e.policy,s=new plupload.Uploader({runtimes:"html5,flash,silverlight,html4",browse_button:$(t).find(".mask")[0],container:t,flash_swf_url:"plupload/Moxie.swf",silverlight_xap_url:"plupload/Moxie.xap",url:a.host,multi_selection:!1,multipart_params:{policy:a.policyBase64,OSSAccessKeyId:a.accessid,success_action_status:"200",signature:a.signature,callback:a.callback},filters:{mime_types:[{title:"Image files",extensions:"jpg,jpeg,png,gif"}],max_file_size:i,limit_sharp:o},init:{PostInit:function(){this._$ele=$(t),this._$imgCt=this._$ele.find(".img-ct"),this._$thumb=this._$ele.find(".thumb"),this._$count=this._$ele.find(".iconfont")},FilesAdded:function(t,e){this._$ele.addClass("uploading"),this._filename=guid()+".jpg",t.setOption({multipart_params:{Filename:this._filename,key:this._filename,policy:a.policyBase64,OSSAccessKeyId:a.accessid,success_action_status:"200",signature:a.signature,callback:a.callback}});var i=this;plupload.each(e,function(t){previewImage(t,function(t){i._$thumb.attr("src",t)}),s.start()})},UploadProgress:function(t,e){this._$count.text(e.percent.toFixed(0)+"%")},FileUploaded:function(t,e,i){this._$ele.removeClass("uploading"),this._$count.remove(),i.status>=200||i.status<200?(console.log("done"),this._$thumb.attr("src",a.host+"/"+this._filename),n(i)):console.log(i.response)},Error:function(t,e){this._$ele.removeClass("uploading");var i={};-888==e.code?i.text="请选择分辨率为 "+e.img.width+" * "+e.img.height+" 的图片":-889==e.code?i.text="请选择分辨率为 "+e.img.width+" * "+e.img.height+" 的图片":-600==e.code?i.text="图片大小超出限制":-601==e.code?i.text="文件格式错误":-200==e.code?i.text="上传错误，请重试":i.text=e.message,$.popup(i)._openPop(),console.log(e)}}});s.init()},$(function(){FastClick.attach(document.body),init(),$.get("http://api.vgee.cn:8080/policy").success(function(t){initUploader($(".pic-ct")[0],t,"2048kb",!1,function(t){console.log("success")})})});